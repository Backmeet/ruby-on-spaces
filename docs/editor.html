<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ROS Editor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/theme/material.min.css" />
<style>
* { box-sizing: border-box; }
body { margin:0; font-family: monospace; background:#6e9acb; overflow:hidden; height:100vh; }
#container { display:flex; height:100vh; width:100vw; }
#leftBar { display:flex; flex-direction:column; width:60px; background:#ccc; align-items:center; justify-content:flex-start; padding:5px; }
#runButton { width:50px; height:50px; background:#0f0; border:2px solid #000; margin-bottom:10px; font-weight:bold; }
#editorWrapper { flex-grow:1; display:flex; flex-direction:column; background:#bbb; height:100%; }
#tabs { display:flex; height:35px; background:#bbb; border-bottom:2px solid black; align-items:center; }
.tab { background:#888; padding:5px 10px; margin-right:5px; border:2px solid black; border-bottom:none; cursor:pointer; display:flex; align-items:center; }
.tab.active { background:#ccc; }
.tab .close { margin-left:8px; color:red; cursor:pointer; }
#addTab { font-size:20px; font-weight:bold; margin-left:auto; margin-right:10px; padding:0 10px; cursor:pointer; background:#ccc; border:2px solid black; }
#editor { flex-grow:1; height:100%; }
.CodeMirror { height:100% !important; }
#outputPanel { width:30%; min-width:200px; background:#bbb; display:flex; flex-direction:column; border-left:2px solid black; }
#outputTitle { text-align:center; font-weight:bold; border-bottom:2px solid black; background:#ccc; padding:5px; }
#output { padding:10px; overflow-y:auto; white-space:pre-wrap; flex-grow:1; background:#000; color:#0f0; font-family:monospace; }
#dragbar { width:5px; cursor:col-resize; background:#222; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/ruby/ruby.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
<div id="container">
<div id="leftBar">
<button id="runButton">RUN</button>
</div>
<div id="editorWrapper">
<div id="tabs"><div id="addTab">+</div></div>
<div id="editor"></div>
</div>
<div id="dragbar"></div>
<div id="outputPanel">
<div id="outputTitle">TERMINAL</div>
<div id="output" contenteditable="false"></div>
</div>
</div>

<script>
const editor = CodeMirror(document.getElementById("editor"), { mode:"ruby", lineNumbers:true, theme:"material" });
const tabs = document.getElementById("tabs");
const addTabBtn = document.getElementById("addTab");
const runButton = document.getElementById("runButton");
const output = document.getElementById("output");

let files = {}, activeFile = null;

function sanitizeFilename(name){return name.endsWith(".ru")?name:name+".ru";}
function createFile(name=null, content=""){
  name = sanitizeFilename(name || `file${Object.keys(files).length + 1}.ru`);
  if(files[name]){alert("File already exists!"); return;}
  files[name]=content;
  const tab=document.createElement("div"); tab.className="tab"; tab.textContent=name;
  const close=document.createElement("span"); close.textContent="Ã—"; close.className="close";
  close.onclick=e=>{e.stopPropagation(); delete files[name]; tabs.removeChild(tab); if(activeFile===name){const next=Object.keys(files)[0]; if(next)switchToFile(next); else{activeFile=null; editor.setValue("");}}};
  tab.appendChild(close); tab.onclick=()=>switchToFile(name);
  tabs.insertBefore(tab, addTabBtn); switchToFile(name);
}
function switchToFile(name){
  if(activeFile) files[activeFile]=editor.getValue();
  activeFile=name; editor.setValue(files[name]||"");
  Array.from(tabs.children).forEach(tab=>tab.classList.toggle("active", tab.textContent.startsWith(name)));
}
addTabBtn.onclick=()=>{const name=prompt("Enter new file name (will be saved as .ru):"); if(name) createFile(name);}
createFile("main.ru");

// --- Terminal logic ---
let waitingForInput=false, resolveInput=null;
let promptText="> ";
let inputStart=0;

function appendTerminal(text){
  output.textContent+=text;
  output.scrollTop=output.scrollHeight;
}

async function promptInput(){
  appendTerminal(promptText);
  output.contentEditable=true;
  waitingForInput=true;
  const range=document.createRange();
  const sel=window.getSelection();
  range.setStart(output.childNodes[0] || output, output.textContent.length);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
  inputStart=output.textContent.length;
  return new Promise(res=>{resolveInput=res;});
}

output.addEventListener("keydown", e=>{
  if(waitingForInput){
    const cursorPos=window.getSelection().focusOffset;

    if(e.key.length===1 && !e.ctrlKey && !e.metaKey) return;

    if(e.key==="Enter"){
      e.preventDefault();
      const userInput=output.textContent.slice(inputStart);
      appendTerminal("\n");
      waitingForInput=false;
      output.contentEditable=false;
      resolveInput(userInput);
      return;
    }

    if(e.key==="Backspace"){
      if(cursorPos<=inputStart){
        e.preventDefault();
        return;
      }
    }

    if(e.ctrlKey && e.key==="c"){
      e.preventDefault();
      appendTerminal("^C\n");
      waitingForInput=false;
      output.contentEditable=false;
      resolveInput(null);
      return;
    }
  } else e.preventDefault();
});

// --- Pyodide + ROS loader ---
let pyodideReady, pyodide;
async function loadPyodideAndROS(){
  pyodide = await loadPyodide({stdout:console.log, stderr:console.error});
  appendTerminal("Pyodide loaded.\n");

  // --- Load latest ROS version from GitHub ---
  const repo="https://api.github.com/repos/Backmeet/ruby-on-spaces/contents/";
  const res = await fetch(repo);
  const data = await res.json();
  const verDirs = data.filter(f=>f.type==="dir" && f.name.startsWith("ver")).map(f=>f.name);

  // Proper version sort (handles decimals like 2.1, 2.10)
  const latestVer = verDirs
    .map(v => v.slice(3))
    .sort((a,b) => {
      const aParts = a.split('.').map(Number);
      const bParts = b.split('.').map(Number);
      for(let i=0;i<Math.max(aParts.length,bParts.length);i++){
        const aNum=aParts[i]||0, bNum=bParts[i]||0;
        if(aNum!==bNum) return bNum-aNum;
      }
      return 0;
    })[0];

  const verName = "ver"+latestVer;
  const verRes = await fetch(repo+verName);
  const verData = await verRes.json();
  const rubyFile = verData.find(f=>f.name==="ruby.py");
  let rubyContent = await fetch(rubyFile.download_url).then(r=>r.text());

  // --- Patch the problematic f-string line ---
  rubyContent = rubyContent.split("\n").map(line=>{
    if(line.includes('raise NameError(f"Undefined variable')) {
      return `
        context_str = ''.join(f'\\n{x}: {y}' for x, y in self.map.items())
        raise NameError(f"Undefined variable {name} in context {context_str}")
      `;
    }
    return line;
  }).join("\n");

  pyodide.FS.writeFile("ruby.py", rubyContent);

  // Patch input() to use terminal
  await pyodide.runPythonAsync(`
import builtins
import asyncio
from js import promptInput, appendTerminal

# Override input()
def input(prompt=None):
    if prompt:
        appendTerminal(str(prompt))
    return asyncio.get_event_loop().run_until_complete(promptInput())

# Override print()
def print(*args, sep=' ', end='\\n'):
    appendTerminal(sep.join(str(a) for a in args) + end)

builtins.input = input
builtins.print = print
`);

  appendTerminal(`ROS v${latestVer} loaded.\n`);
}
pyodideReady=loadPyodideAndROS();

// --- Run code ---
runButton.onclick=async()=>{
  if(!activeFile) return; files[activeFile]=editor.getValue();
  await pyodideReady;
  const sources={};
  for(const [name, content] of Object.entries(files)){if(name!==activeFile)sources[name]=content;}
  const code = files[activeFile];
  const sourcesDict = JSON.stringify(sources);
  const fullCode = `
from ruby import make_global_env, run
env = make_global_env(${sourcesDict})
run("""${code.replace(/\\/g,"\\\\").replace(/"""/g,'\\"""')}""", env)
`;
  appendTerminal("\nRunning...\n");
  try{await pyodide.runPythonAsync(fullCode);}catch(e){appendTerminal("\nError: "+e+"\n");}
};

// --- Resizable dragbar ---
const dragbar=document.getElementById("dragbar"); const outputPanel=document.getElementById("outputPanel"); let dragging=false;
dragbar.addEventListener("mousedown",()=>{dragging=true; document.body.style.cursor="col-resize";});
document.addEventListener("mouseup",()=>{dragging=false; document.body.style.cursor="default";});
document.addEventListener("mousemove",e=>{if(!dragging) return; const percent=(window.innerWidth-e.clientX)/window.innerWidth; outputPanel.style.width=`${Math.max(20, percent*100)}%`;});
</script>

</body>
</html>
